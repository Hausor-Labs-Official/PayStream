import { ethers } from 'ethers';
import dotenv from 'dotenv';
import fs from 'fs';

dotenv.config({ path: '.env.local' });

// Simplified BatchPayer bytecode (no constructor args needed)
const BYTECODE = '0x6080604052348015600e575f5ffd5b50335f5f6101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055506107998061005b5f395ff3fe60806040526004361061002c575f3560e01c80634c73d125146100375780638da5cb5b1461005357610033565b3661003357005b5f5ffd5b610051600480360381019061004c91906103b1565b61007d565b005b34801561005e575f5ffd5b506100676102cf565b604051610074919061046e565b60405180910390f35b5f5f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff161461010b576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610102906104e1565b60405180910390fd5b818190508484905014610153576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161014a90610549565b60405180910390fd5b5f5f90505f5f90505b858590508110156102845783838281811061017a57610179610567565b5b905060200201358261018c91906105ca565b91505f8686838181106101a2576101a1610567565b5b90506020020160208101906101b79190610627565b73ffffffffffffffffffffffffffffffffffffffff168585848181106101e0576101df610567565b5b905060200201356040516101f39061067f565b5f6040518083038185875af1925050503d805f811461022d576040519150601f19603f3d011682016040523d82523d5f602084013e610232565b606091505b5050905080610276576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161026d906106dd565b60405180910390fd5b50808060010191505061015c565b50803410156102c8576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016102bf90610745565b60405180910390fd5b5050505050565b5f5f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b5f5ffd5b5f5ffd5b5f5ffd5b5f5ffd5b5f5ffd5b5f5f83601f84011261031c5761031b6102fb565b5b8235905067ffffffffffffffff811115610339576103386102ff565b5b60208301915083602082028301111561035557610354610303565b5b9250929050565b5f5f83601f840112610371576103706102fb565b5b8235905067ffffffffffffffff81111561038e5761038d6102ff565b5b6020830191508360208202830111156103aa576103a9610303565b5b9250929050565b5f5f5f5f604085870312156103c9576103c86102f3565b5b5f85013567ffffffffffffffff8111156103e6576103e56102f7565b5b6103f287828801610307565b9450945050602085013567ffffffffffffffff811115610415576104146102f7565b5b6104218782880161035c565b925092505092959194509250565b5f73ffffffffffffffffffffffffffffffffffffffff82169050919050565b5f6104588261042f565b9050919050565b6104688161044e565b82525050565b5f6020820190506104815f83018461045f565b92915050565b5f82825260208201905092915050565b7f4e6f74206f776e657200000000000000000000000000000000000000000000005f82015250565b5f6104cb600983610487565b91506104d682610497565b602082019050919050565b5f6020820190508181035f8301526104f8816104bf565b9050919050565b7f417272617973206c656e677468206d69736d61746368000000000000000000005f82015250565b5f610533601683610487565b915061053e826104ff565b602082019050919050565b5f6020820190508181035f83015261056081610527565b9050919050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52603260045260245ffd5b5f819050919050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52601160045260245ffd5b5f6105d482610594565b91506105df83610594565b92508282019050808211156105f7576105f661059d565b5b92915050565b6106068161044e565b8114610610575f5ffd5b50565b5f81359050610621816105fd565b92915050565b5f6020828403121561063c5761063b6102f3565b5b5f61064984828501610613565b91505092915050565b5f81905092915050565b50565b5f61066a5f83610652565b91506106758261065c565b5f82019050919050565b5f6106898261065f565b9150819050919050565b7f5472616e73666572206661696c656400000000000000000000000000000000005f82015250565b5f6106c7600f83610487565b91506106d282610693565b602082019050919050565b5f6020820190508181035f8301526106f4816106bb565b9050919050565b7f496e73756666696369656e7420555344432073656e74000000000000000000005f82015250565b5f61072f601683610487565b915061073a826106fb565b602082019050919050565b5f6020820190508181035f83015261075c81610723565b905091905056fea26469706673582212206b0fb843058ff1502133af2dca1f68f19e8668ab895bc5b2fde4b860599f1a7c64736f6c634300081e0033';

async function deploy() {
  console.log('üöÄ Deploying Simplified BatchPayer to Arc Testnet\n');

  const provider = new ethers.JsonRpcProvider(process.env.ARC_RPC_URL);
  const signer = new ethers.Wallet(process.env.ETHER_PRIVATE_KEY!, provider);

  console.log('Deployer:', signer.address);

  // Check balance
  const balance = await provider.getBalance(signer.address);
  console.log('Balance:', ethers.formatEther(balance), 'USDC\n');

  try {
    console.log('Sending deployment transaction...');

    const tx = await signer.sendTransaction({
      data: BYTECODE,
      gasLimit: 600000,
    });

    console.log('TX Hash:', tx.hash);
    console.log('Waiting for confirmation...\n');

    const receipt = await tx.wait();

    if (!receipt) {
      throw new Error('No receipt returned');
    }

    if (receipt.status === 0) {
      throw new Error('Transaction reverted');
    }

    const contractAddress = receipt.contractAddress;
    console.log('‚úÖ Contract Deployed Successfully!');
    console.log('Contract Address:', contractAddress);
    console.log('Block Number:', receipt.blockNumber);
    console.log('Gas Used:', receipt.gasUsed.toString());
    console.log('Arc Explorer:', `https://testnet.arcscan.app/address/${contractAddress}\n`);

    // Update .env.local
    const envPath = '.env.local';
    let envContent = fs.readFileSync(envPath, 'utf8');

    if (envContent.includes('BATCH_PAYER_ADDRESS=')) {
      envContent = envContent.replace(
        /BATCH_PAYER_ADDRESS=.*/,
        `BATCH_PAYER_ADDRESS=${contractAddress}`
      );
    } else {
      envContent += `\n# === BATCH PAYER CONTRACT ===\nBATCH_PAYER_ADDRESS=${contractAddress}\n`;
    }

    fs.writeFileSync(envPath, envContent);
    console.log('‚úÖ Updated .env.local with contract address');
  } catch (error) {
    console.error('‚ùå Deployment failed:', error);
    throw error;
  }
}

deploy();
