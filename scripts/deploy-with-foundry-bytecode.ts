import { ethers } from 'ethers';
import dotenv from 'dotenv';
import fs from 'fs';

dotenv.config({ path: '.env.local' });

// Bytecode from Foundry compilation
const BYTECODE = '0x60c060405234801561000f575f5ffd5b50604051610fef380380610fef83398181016040528101906100319190610162565b5f73ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff1603610096576040517fd92e233d00000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b3373ffffffffffffffffffffffffffffffffffffffff1660808173ffffffffffffffffffffffffffffffffffffffff16815250508073ffffffffffffffffffffffffffffffffffffffff1660a08173ffffffffffffffffffffffffffffffffffffffff16815250505061018d565b5f5ffd5b5f73ffffffffffffffffffffffffffffffffffffffff82169050919050565b5f61013182610108565b9050919050565b61014181610127565b811461014b575f5ffd5b50565b5f8151905061015c81610138565b92915050565b5f6020828403121561017757610176610104565b5b5f6101848482850161014e565b91505092915050565b60805160a051610e106101df5f395f818161027981526104c301525f8181610154015281816101f50152818161029d01528181610503015281816105da015281816106c101526108cf0152610e105ff3fe608060405234801561000f575f5ffd5b506004361061007a575f3560e01c80634c73d125116100595780634c73d125146100d65780638da5cb5b146100f2578063c59d484714610110578063f41cb5d11461012f5761007a565b80625b44871461007e578063069c9fae1461009c57806311eac855146100b8575b5f5ffd5b61008661014d565b604051610093919061091e565b60405180910390f35b6100b660048036038101906100b191906109c3565b610152565b005b6100c0610277565b6040516100cd9190610a10565b60405180910390f35b6100f060048036038101906100eb9190610adf565b61029b565b005b6100fa6108cd565b6040516101079190610a10565b60405180910390f35b6101186108f1565b604051610126929190610b5d565b60405180910390f35b610137610900565b604051610144919061091e565b60405180910390f35b5f5481565b7f000000000000000000000000000000000000000000000000000000000000000073ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16146101d7576040517f5fc483c500000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b8173ffffffffffffffffffffffffffffffffffffffff1663a9059cbb7f0000000000000000000000000000000000000000000000000000000000000000836040518363ffffffff1660e01b8152600401610232929190610b84565b6020604051808303815f875af115801561024e573d5f5f3e3d5ffd5b505050506040513d601f19601f820116820180604052508101906102729190610be0565b505050565b7f000000000000000000000000000000000000000000000000000000000000000081565b7f000000000000000000000000000000000000000000000000000000000000000073ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614610320576040517f5fc483c500000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b5f8484905090505f8103610360576040517f9d89020a00000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b82829050811461039c576040517ffc23596000000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b5f5f90505f5f90505b828110156104bf575f73ffffffffffffffffffffffffffffffffffffffff168787838181106103d7576103d6610c0b565b5b90506020020160208101906103ec9190610c38565b73ffffffffffffffffffffffffffffffffffffffff1603610439576040517fd92e233d00000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b5f85858381811061044d5761044c610c0b565b5b905060200201350361048b576040517f1f2a200500000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b84848281811061049e5761049d610c0b565b5b90506020020135826104b09190610c90565b915080806001019150506103a5565b505f7f000000000000000000000000000000000000000000000000000000000000000090505f8173ffffffffffffffffffffffffffffffffffffffff1663dd62ed3e7f0000000000000000000000000000000000000000000000000000000000000000306040518363ffffffff1660e01b8152600401610540929190610cc3565b602060405180830381865afa15801561055b573d5f5f3e3d5ffd5b505050506040513d601f19601f8201168201806040525081019061057f9190610cfe565b9050828110156105bb576040517f13be252b00000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b5f8273ffffffffffffffffffffffffffffffffffffffff166370a082317f00000000000000000000000000000000000000000000000000000000000000006040518263ffffffff1660e01b81526004016106159190610a10565b602060405180830381865afa158015610630573d5f5f3e3d5ffd5b505050506040513d601f19601f820116820180604052508101906106549190610cfe565b905083811015610690576040517ff4d678b800000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b5f5f5490505f5f90505b86811015610856575f8573ffffffffffffffffffffffffffffffffffffffff166323b872dd7f00000000000000000000000000000000000000000000000000000000000000008e8e868181106106f3576106f2610c0b565b5b90506020020160208101906107089190610c38565b8d8d8781811061071b5761071a610c0b565b5b905060200201356040518463ffffffff1660e01b815260040161074093929190610d29565b6020604051808303815f875af115801561075c573d5f5f3e3d5ffd5b505050506040513d601f19601f820116820180604052508101906107809190610be0565b9050806107b9576040517f90b8ec1800000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b8b8b838181106107cc576107cb610c0b565b5b90506020020160208101906107e19190610c38565b73ffffffffffffffffffffffffffffffffffffffff16837f260ad67acf3c85dc2251795183fe2834b0a5bec7b3eeb69b4c45bbddc9fd310b8c8c8681811061082c5761082b610c0b565b5b90506020020135604051610840919061091e565b60405180910390f35b50508061034290610d5e565b9050610309565b505f5f81548092919061086890610d5e565b91905055508460015f82825461087e9190610c90565b92505081905550807feb0f93a1ecd9e52ce540047ed8cd537637fceb9c281e632065dad34e80e950d78787426040516108b993929190610da5565b60405180910390a250505050505050505050565b7f000000000000000000000000000000000000000000000000000000000000000081565b5f5f5f54600154915091509091565b60015481565b5f819050919050565b61091881610906565b82525050565b5f6020820190506109315f83018461090f565b92915050565b5f5ffd5b5f5ffd5b5f73ffffffffffffffffffffffffffffffffffffffff82169050919050565b5f6109688261093f565b9050919050565b6109788161095e565b8114610982575f5ffd5b50565b5f813590506109938161096f565b92915050565b6109a281610906565b81146109ac575f5ffd5b50565b5f813590506109bd81610999565b92915050565b5f5f604083850312156109d9576109d8610937565b5b5f6109e685828601610985565b92505060206109f7858286016109af565b9150509250929050565b610a0a8161095e565b82525050565b5f602082019050610a235f830184610a01565b92915050565b5f5ffd5b5f5ffd5b5f5ffd5b5f5f83601f840112610a4a57610a49610a29565b5b8235905067ffffffffffffffff811115610a6757610a66610a2d565b5b602083019150836020820283011115610a8357610a82610a31565b5b9250929050565b5f5f83601f840112610a9f57610a9e610a29565b5b8235905067ffffffffffffffff811115610abc57610abb610a2d565b5b602083019150836020820283011115610ad857610ad7610a31565b5b9250929050565b5f5f5f5f60408587031215610af757610af6610937565b5b5f85013567ffffffffffffffff811115610b1457610b1361093b565b5b610b2087828801610a35565b9450945050602085013567ffffffffffffffff811115610b4357610b4261093b565b5b610b4f87828801610a8a565b925092505092959194509250565b5f604082019050610b705f83018561090f565b610b7d602083018461090f565b9392505050565b5f604082019050610b975f830185610a01565b610ba4602083018461090f565b9392505050565b5f8115159050919050565b610bbf81610bab565b8114610bc9575f5ffd5b50565b5f81519050610bda81610bb6565b92915050565b5f60208284031215610bf557610bf4610937565b5b5f610c0284828501610bcc565b91505092915050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52603260045260245ffd5b5f60208284031215610c4d57610c4c610937565b5b5f610c5a84828501610985565b91505092915050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52601160045260245ffd5b5f610c9a82610906565b9150610ca583610906565b9250828201905080821115610cbd57610cbc610c63565b5b92915050565b5f604082019050610cd65f830185610a01565b610ce36020830184610a01565b9392505050565b5f81519050610cf881610999565b92915050565b5f60208284031215610d1357610d12610937565b5b5f610d2084828501610cea565b91505092915050565b5f606082019050610d3c5f830186610a01565b610d496020830185610a01565b610d56604083018461090f565b949350505050565b5f610d6882610906565b91507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8203610d9a57610d99610c63565b5b600182019050919050565b5f606082019050610db85f83018661090f565b610dc5602083018561090f565b610dd2604083018461090f565b94935050505056fea2646970667358221220dc8a952c76d0d92de5ca895a5b65b76bb09b5bc636e2c20a715b4a779431bb3c64736f6c634300081e00330000000000000000000000003600000000000000000000000000000000000000';

async function deploy() {
  console.log('üöÄ Deploying BatchPayer to Arc Testnet\n');

  const provider = new ethers.JsonRpcProvider(process.env.ARC_RPC_URL);
  const signer = new ethers.Wallet(process.env.ETHER_PRIVATE_KEY!, provider);

  console.log('Deployer:', signer.address);

  // Check balance
  const balance = await provider.getBalance(signer.address);
  console.log('Balance:', ethers.formatEther(balance), 'tokens\n');

  try {
    // Encode constructor argument (USDC token address)
    const usdcAddress = process.env.USDC_CONTRACT_ADDRESS!;
    const encodedArgs = ethers.AbiCoder.defaultAbiCoder().encode(
      ['address'],
      [usdcAddress]
    );

    // Combine bytecode with constructor arguments
    const fullBytecode = BYTECODE + encodedArgs.slice(2); // Remove 0x from encoded args

    console.log('USDC Token Address:', usdcAddress);
    console.log('Sending deployment transaction...');

    const tx = await signer.sendTransaction({
      data: fullBytecode,
      gasLimit: 1000000,
    });

    console.log('TX Hash:', tx.hash);
    console.log('Waiting for confirmation...\n');

    const receipt = await tx.wait();

    if (!receipt) {
      throw new Error('No receipt returned');
    }

    const contractAddress = receipt.contractAddress;
    console.log('‚úÖ Contract Deployed Successfully!');
    console.log('Contract Address:', contractAddress);
    console.log('Block Number:', receipt.blockNumber);
    console.log('Gas Used:', receipt.gasUsed.toString());
    console.log('Arc Explorer:', `https://testnet.arcscan.app/address/${contractAddress}\n`);

    // Update .env.local
    const envPath = '.env.local';
    let envContent = fs.readFileSync(envPath, 'utf8');

    if (envContent.includes('BATCH_PAYER_ADDRESS=')) {
      envContent = envContent.replace(
        /BATCH_PAYER_ADDRESS=.*/,
        `BATCH_PAYER_ADDRESS=${contractAddress}`
      );
    } else {
      envContent += `\n# === BATCH PAYER CONTRACT ===\nBATCH_PAYER_ADDRESS=${contractAddress}\n`;
    }

    fs.writeFileSync(envPath, envContent);
    console.log('‚úÖ Updated .env.local with contract address');
  } catch (error) {
    console.error('‚ùå Deployment failed:', error);
    throw error;
  }
}

deploy();
